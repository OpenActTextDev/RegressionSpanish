#  FILENAME IS Chap18RCode.txt  ;

setwd("c://BOOK3//CUPBook//Chapter18CredibilityBM")
#setwd("R://BOOK3//CUPBook//Chapter18CredibilityBM")
library(HH)


y = c(14,12,10,12,
      9, 16,15,12,
      8, 10, 7, 7)
group = c(1,1,1,1,2,2,2,2,3,3,3,3)

#  FIXED EFFECTS MODEL
lm1<-lm(y~factor(group))
summary(lm1)


#  RANDOM EFFECTS MODEL
library(nlme)
lme2<-lme(y~1, random=~1|group, method="REML") 
lme3<-lme(y~1, random=~1|group, method="ML") 
# NOTE* THE DEFAULT METHOD IN lme IS "REML"
# Use REML method in estimating fixed effects beta coefficients 
summary(lme2)
summary(lme3)

#  FIGURE 18.1
plot.new()
par(mar=c(0,0,0,0), cex=1.5)
plot.window(xlim=c(0,14),ylim=c(-0.5,4.5))

arrows(1,3,13.5,3,code=2,lwd=2,angle=0,length=0.10)
text(2.1,3,labels="|",adj=0)
text(2,3.5,"8",adj=0, cex=0.8)
text(2,4,expression(bar(y)[3]),adj=0, cex=0.8)
text(8.1,3,labels="|",adj=0)
text(7.9,3.5,"11",adj=0, cex=0.8)
text(8,4,expression(bar(y)),adj=0, cex=0.8)
text(10.1,3,labels="|",adj=0)
text(9.9,3.5,"12",adj=0, cex=0.8)
text(10,4,expression(bar(y)[1]),adj=0, cex=0.8)
text(12.1,3,labels="|",adj=0)
text(11.9,3.5,"13",adj=0, cex=0.8)
text(12,4,expression(bar(y)[3]),adj=0, cex=0.8)

arrows(1,1,13.5,1,code=2,lwd=2,angle=0,length=0.10)
text(2.6,1,labels="|",adj=0)
text(2.3,0.5,"8.786",adj=0, cex=0.8)
text(2.5,0,expression(bar(y)["3,s"]),adj=0, cex=0.8)

text(9.6,1,labels="|",adj=0)
text(9.2,0.5,"11.738",adj=0, cex=0.8)
text(9.5,0,expression(bar(y)["1,s"]),adj=0, cex=0.8)

text(11.6,1,labels="|",adj=0)
text(11.2,0.5,"12.476",adj=0, cex=0.8)
text(11.5,0,expression(bar(y)["2,s"]),adj=0, cex=0.8)

arrows(2.1,3,2.6,1,code=2,lwd=1,angle=0,length=0.10)
arrows(10.1,3,9.6,1,code=2,lwd=1,angle=0,length=0.10)

arrows(12.1,3,11.6,1,code=2,lwd=1,angle=0,length=0.10)

#text(4,2,expression(y[L]^{"*"}),adj=0, cex=0.8)
#text(8,2,expression(y[U]^{"*"}),adj=0, cex=0.8)

export.eps("F18Shrinkage.eps", width=8,height=3) 
dev.off()

#  WORKERS COMPENSATION DATA
WorkersC <- read.csv(file.choose(),quote="",header=TRUE)
str(WorkersC)

WorkersC$PP <- WorkersC$LOSS/WorkersC$PR
WorkersC2 = subset(WorkersC, PR> 0 )

#  ONLY MODEL SEVERITY PORTION
WorkersC3 = subset(WorkersC, PP> 0 )
attach(WorkersC3)
hist(PP)

lnPP <- log(PP)
hist(lnPP)

#  FIXED EFFECTS MODEL
lm1<-lm(lnPP~factor(CL))
summary(lm1)
plot(lm1)



#  RANDOM EFFECTS MODEL
library(nlme)
#  BUHLMANN
lme2<-lme(lnPP~1, random=~1|CL, method="ML") 
summary(lme2)
#  BUHLMANN - STRAUB
lme3<-lme(lnPP~1, random=~1|CL, weights=varFixed(~1/sqrt(PR)), method="ML" ) 
summary(lme3)
plot(lme3)
#  HACHEMEISTER
lme4<-lme(lnPP~1+YR, random=~1+YR|CL, weights=varFixed(~1/sqrt(PR)), method="ML" ) 
summary(lme4)
plot(lme4)
#  IN BETWEEN
lme5<-lme(lnPP~1, random=~1+YR|CL, weights=varFixed(~1/sqrt(PR)), method="ML" ) 
summary(lme5)
plot(lme5)

#  PREDICTIONS  
#  BUHLMANN

random.effects(lme2)
#test = random.effects(lme2) -coef(lme2);test


FE <- 1:5
FE[1] <- (coef(lm1))[1]
FE[2] <- (coef(lm1))[1]+(coef(lm1))[2]
FE[3] <- (coef(lm1))[1]+(coef(lm1))[3]
FE[4] <- (coef(lm1))[1]+(coef(lm1))[4]
FE[5] <- (coef(lm1))[1]+(coef(lm1))[5]
FEexp <- exp(FE)
Buhlmann  <- exp((coef(lme2))[1:5,])
BS <- exp((coef(lme3))[1:5,])
Hach8 <- exp((coef(lme4))[1:5,1]+8*(coef(lme4))[1:5,2])
Between8 <- exp((coef(lme5))[1:5,1]+8*(coef(lme5))[1:5,2])

summvar <- 1000*cbind(FEexp, Buhlmann,BS, Hach8,Between8);summvar

write.csv(summvar, file = "Chap18CredPred.csv")






